{% from "macros/_icons.html" import icon %}

<tr id="time-entry-row-{{ entry.id }}"
    class="{% if loop is defined and loop.index is even %}bg-base-200{% endif %} border-b border-base-300 cursor-pointer hover:bg-base-300/50 transition-colors"
    hx-get="/time-entries/{{ entry.id }}/edit-row"
    hx-target="closest tr"
    hx-swap="outerHTML"
    hx-trigger="click">
    {# 1. Tag (Date) #}
    <td class="py-3 px-4 text-sm">
        {% set weekday_map = {'0': 'So', '1': 'Mo', '2': 'Di', '3': 'Mi', '4': 'Do', '5': 'Fr', '6': 'Sa'} %}
        {% set weekday = weekday_map[entry.work_date.strftime('%w')] %}
        {{ entry.work_date.strftime('%d.%m.%y') }} <span class="text-xs text-base-content/50">({{ weekday }})</span>
        {% if is_holiday %}
        <span class="ml-2 badge badge-warning badge-sm" title="{{ holiday_name }}">{{ icon("party-popper", class="w-3 h-3") }}</span>
        {% endif %}
    </td>

    {# 2. Ankunft (Start Time) #}
    <td class="py-3 px-4 text-sm">{{ entry.start_time.strftime('%H:%M') if entry.start_time else '' }}</td>

    {# 3. Ende (End Time) #}
    <td class="py-3 px-4 text-sm">{{ entry.end_time.strftime('%H:%M') if entry.end_time else '' }}</td>

    {# 4. Pausen (Break) #}
    <td class="py-3 px-4 text-sm">{{ entry.break_minutes|format_duration if entry.break_minutes else '' }}</td>

    {# 5. Arbeitsstunden Real (Actual Hours) #}
    <td class="py-3 px-4 text-sm bg-info/10">
        {% if entry.absence_type.value in ['vacation', 'sick', 'holiday', 'flex_time'] %}
            {{ target_hours|format_hours }}
        {% else %}
            {{ actual_hours|format_hours if actual_hours else '' }}
        {% endif %}
    </td>

    {# 6. Arbeitsstunden Soll (Target Hours) #}
    <td class="py-3 px-4 text-sm">{{ target_hours|format_hours }}</td>

    {# 7. +/- (Balance) #}
    <td class="py-3 px-4 text-sm {% if balance >= 0 %}text-success{% else %}text-error{% endif %}">
        {{ balance|format_balance }}
    </td>

    {# 8. Abwesenheit / Bemerkung (Notes) #}
    <td class="py-3 px-4 text-sm text-base-content/70">
        {% if entry.notes %}
        <div class="tooltip tooltip-top" data-tip="{{ entry.notes }}">
            {{ icon("message-square", class="w-4 h-4 text-base-content/40") }}
        </div>
        {% endif %}
    </td>

    {# 9. Quick Absence Buttons #}
    <td class="py-3 px-4 text-center" onclick="event.stopPropagation()">
        <div class="flex gap-1 justify-center">
            {# Urlaub (Vacation) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'vacation' %}!bg-primary/30 !border-2 !border-primary !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Urlaub"
                    title="Urlaub"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'vacation' %}none{% else %}vacation{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("tree-palm", class="w-4 h-4") }}
            </button>

            {# Krank (Sick) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'sick' %}!bg-error/30 !border-2 !border-error !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Krank"
                    title="Krank"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'sick' %}none{% else %}sick{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("thermometer", class="w-4 h-4") }}
            </button>

            {# Feiertag (Holiday) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'holiday' %}!bg-warning/30 !border-2 !border-warning !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Feiertag"
                    title="Feiertag"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'holiday' %}none{% else %}holiday{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("party-popper", class="w-4 h-4") }}
            </button>

            {# Gleitzeit (Flex Time) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'flex_time' %}!bg-info/30 !border-2 !border-info !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Gleitzeit"
                    title="Gleitzeit"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'flex_time' %}none{% else %}flex_time{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("clock-arrow-down", class="w-4 h-4") }}
            </button>
        </div>
    </td>

    {# 10. Actions #}
    <td class="py-3 px-4 w-32" onclick="event.stopPropagation()">
        <div class="flex gap-1 items-center justify-end">
            {# Copy to new row button #}
            <button type="button"
                    class="btn btn-ghost btn-xs min-w-11 min-h-11 opacity-40 hover:opacity-100"
                    onclick="copyEntryToNew({{ entry.id }})"
                    title="Als Vorlage kopieren"
                    aria-label="Als Vorlage kopieren">
                {{ icon("clipboard", class="w-3 h-3") }}
            </button>

            {# Delete button - red/error styling #}
            <button type="button"
                    class="btn btn-ghost btn-xs min-w-11 min-h-11 text-error opacity-40 hover:opacity-100 hover:bg-error/20"
                    onclick="showDeleteModal({
                        title: 'Eintrag löschen?',
                        message: 'Diese Aktion kann nicht rückgängig gemacht werden.',
                        onConfirm: () => {
                            htmx.ajax('DELETE', '/time-entries/{{ entry.id }}', {
                                target: '#time-entry-row-{{ entry.id }}',
                                swap: 'delete'
                            });
                        }
                    }); return false;"
                    title="Löschen"
                    aria-label="Löschen">
                {{ icon("trash-2", class="w-3 h-3") }}
            </button>
        </div>
    </td>
</tr>
