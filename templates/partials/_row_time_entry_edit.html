{% from "macros/_icons.html" import icon %}

{# Determine if this is a new entry or existing #}
{% set is_new = entry is none %}
{% set row_id = "time-entry-row-new" if is_new else "time-entry-row-" ~ entry.id %}

{# Calculate actual_hours and balance for display-only fields #}
{% if not is_new and entry.start_time and entry.end_time %}
    {% set actual_minutes = (entry.end_time.hour * 60 + entry.end_time.minute) - (entry.start_time.hour * 60 + entry.start_time.minute) - (entry.break_minutes or 0) %}
    {% set actual_hours = (actual_minutes / 60)|round(2) %}
{% else %}
    {% set actual_hours = 0 %}
{% endif %}
{% set target_hours = 8.0 %}
{% set balance = actual_hours - target_hours %}

<tr id="{{ row_id }}"
    data-edit-row
    class="{% if not is_new and loop is defined and loop.index is even %}bg-base-200{% endif %} border-b border-base-300 bg-warning/5">

    {# 1. Tag (Date) - Read-only for existing, input for new #}
    <td class="py-3 px-4 text-sm">
        {% if is_new %}
        <input type="date"
               name="work_date"
               value="{{ default_date.strftime('%Y-%m-%d') if default_date else '' }}"
               class="input input-sm input-bordered w-32"
               required />
        {% else %}
        {% set weekday_map = {'0': 'So', '1': 'Mo', '2': 'Di', '3': 'Mi', '4': 'Do', '5': 'Fr', '6': 'Sa'} %}
        {% set weekday = weekday_map[entry.work_date.strftime('%w')] %}
        {{ entry.work_date.strftime('%d.%m.%y') }} <span class="text-xs text-base-content/50">({{ weekday }})</span>
        {% if is_holiday %}
        <span class="ml-2 badge badge-warning badge-sm" title="{{ holiday_name }}">{{ icon("party-popper", class="w-3 h-3") }}</span>
        {% endif %}
        <input type="hidden" name="work_date" value="{{ entry.work_date.strftime('%Y-%m-%d') }}" />
        {# Optimistic locking timestamp #}
        <input type="hidden" name="updated_at" value="{{ entry.updated_at.isoformat() }}" />
        {% endif %}
    </td>

    {# 2. Ankunft (Start Time) #}
    <td class="py-3 px-4">
        <input type="text"
               name="start_time"
               value="{{ entry.start_time.strftime('%H:%M') if entry and entry.start_time else (default_start_time or '') }}"
               pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
               placeholder="08:00"
               class="input input-sm input-bordered w-20"
               title="Format: HH:MM (z.B. 08:00)"
               tabindex="1" />
    </td>

    {# 3. Ende (End Time) #}
    <td class="py-3 px-4">
        <input type="text"
               name="end_time"
               value="{{ entry.end_time.strftime('%H:%M') if entry and entry.end_time else (default_end_time or '') }}"
               pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
               placeholder="16:00"
               class="input input-sm input-bordered w-20"
               title="Format: HH:MM (z.B. 16:00)"
               tabindex="2" />
    </td>

    {# 4. Pausen (Break in minutes) #}
    <td class="py-3 px-4">
        <input type="number"
               name="break_minutes"
               value="{{ entry.break_minutes if entry else (default_break_minutes if default_break_minutes is defined else 30) }}"
               min="0"
               max="480"
               step="5"
               class="input input-sm input-bordered w-16"
               title="Pausenzeit in Minuten"
               tabindex="3" />
    </td>

    {# 5. Arbeitsstunden Real (Display-only, calculated) #}
    <td class="py-3 px-4 text-sm bg-info/10">
        {% if not is_new and actual_hours %}
        {{ actual_hours|format_hours }}
        {% endif %}
    </td>

    {# 6. Arbeitsstunden Soll (Display-only) #}
    <td class="py-3 px-4 text-sm">{{ target_hours|format_hours }}</td>

    {# 7. +/- (Display-only, calculated) #}
    <td class="py-3 px-4 text-sm {% if balance >= 0 %}text-success{% else %}text-error{% endif %}">
        {% if not is_new %}
        {{ balance|format_balance }}
        {% endif %}
    </td>

    {# 8. Bemerkung (Notes) #}
    <td class="py-3 px-4">
        <input type="text"
               name="notes"
               value="{{ entry.notes or '' if entry else '' }}"
               placeholder="Bemerkung"
               maxlength="500"
               class="input input-sm input-bordered w-full"
               tabindex="4" />
    </td>

    {# 9. Abwesenheit (Absence buttons - same as view mode) #}
    <td class="py-3 px-4 text-center">
        <div class="flex gap-1 justify-center">
            {# For new entries, show disabled placeholder buttons #}
            {% if is_new %}
            <span class="text-xs text-base-content/40">Nach Speichern</span>
            {% else %}
            {# Urlaub (Vacation) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'vacation' %}!bg-primary/30 !border-2 !border-primary !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Urlaub"
                    title="Urlaub"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'vacation' %}none{% else %}vacation{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("tree-palm", class="w-4 h-4") }}
            </button>

            {# Krank (Sick) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'sick' %}!bg-error/30 !border-2 !border-error !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Krank"
                    title="Krank"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'sick' %}none{% else %}sick{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("thermometer", class="w-4 h-4") }}
            </button>

            {# Feiertag (Holiday) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'holiday' %}!bg-warning/30 !border-2 !border-warning !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Feiertag"
                    title="Feiertag"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'holiday' %}none{% else %}holiday{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("party-popper", class="w-4 h-4") }}
            </button>

            {# Gleitzeit (Flex Time) #}
            <button type="button"
                    class="btn btn-xs btn-ghost min-w-11 min-h-11 {% if entry.absence_type.value == 'flex_time' %}!bg-info/30 !border-2 !border-info !opacity-100{% else %}opacity-60 hover:opacity-100{% endif %}"
                    aria-label="Gleitzeit"
                    title="Gleitzeit"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-vals='{"absence_type": "{% if entry.absence_type.value == 'flex_time' %}none{% else %}flex_time{% endif %}", "updated_at": "{{ entry.updated_at.isoformat() }}"}'
                    hx-target="closest tr"
                    hx-swap="outerHTML">
                {{ icon("clock-arrow-down", class="w-4 h-4") }}
            </button>
            {% endif %}
        </div>
    </td>

    {# 10. Actions #}
    <td class="py-3 px-4 w-32">
        <div class="flex gap-1 items-center justify-end">
            {# Copy Last button #}
            <button type="button"
                    class="btn btn-secondary btn-xs min-w-11 min-h-11"
                    onclick="copyLastEntry(this)"
                    title="Letzte kopieren"
                    aria-label="Letzte kopieren"
                    tabindex="8">
                {{ icon("clipboard", class="w-3 h-3") }}
            </button>

            {# Save button #}
            {% if is_new %}
            <button type="button"
                    class="btn btn-primary btn-xs min-w-11 min-h-11"
                    hx-post="/time-entries"
                    hx-include="closest tr"
                    hx-target="closest tr"
                    hx-swap="outerHTML"
                    title="Speichern"
                    aria-label="Speichern"
                    tabindex="5">
                {{ icon("check", class="w-3 h-3") }}
            </button>
            {% else %}
            <button type="button"
                    class="btn btn-primary btn-xs min-w-11 min-h-11"
                    hx-patch="/time-entries/{{ entry.id }}"
                    hx-include="closest tr"
                    hx-target="closest tr"
                    hx-swap="outerHTML"
                    title="Speichern"
                    aria-label="Speichern"
                    tabindex="5">
                {{ icon("check", class="w-3 h-3") }}
            </button>
            {% endif %}

            {# Cancel button #}
            {% if is_new %}
            <button type="button"
                    class="btn btn-ghost btn-xs min-w-11 min-h-11"
                    onclick="cancelNewEntry(this)"
                    title="Abbrechen"
                    aria-label="Abbrechen"
                    tabindex="9">
                {{ icon("x", class="w-3 h-3") }}
            </button>
            {% else %}
            <button type="button"
                    class="btn btn-ghost btn-xs min-w-11 min-h-11"
                    hx-get="/time-entries/{{ entry.id }}/row"
                    hx-target="closest tr"
                    hx-swap="outerHTML"
                    title="Abbrechen"
                    aria-label="Abbrechen"
                    tabindex="9">
                {{ icon("x", class="w-3 h-3") }}
            </button>
            {% endif %}

            {# Delete button - only for existing entries #}
            {% if not is_new %}
            <button type="button"
                    class="btn btn-error btn-xs min-w-11 min-h-11"
                    onclick="showDeleteModal({
                        title: 'Eintrag löschen?',
                        message: 'Diese Aktion kann nicht rückgängig gemacht werden.',
                        onConfirm: () => {
                            htmx.ajax('DELETE', '/time-entries/{{ entry.id }}', {
                                target: '#time-entry-row-{{ entry.id }}',
                                swap: 'delete'
                            });
                        }
                    }); return false;"
                    title="Löschen"
                    aria-label="Löschen"
                    tabindex="10">
                {{ icon("trash-2", class="w-3 h-3") }}
            </button>
            {% endif %}
        </div>
    </td>
</tr>

{# Hide empty state when this edit row is shown for new entry #}
{% if is_new %}
<tr id="empty-state-row" hx-swap-oob="outerHTML:#empty-state-row" style="display: none;">
</tr>
{% endif %}

{# JavaScript for cancel button behavior on new entries #}
{% if is_new %}
<script>
window.cancelNewEntry = function(button) {
    const editRow = button.closest('tr');
    const tbody = editRow.parentElement;

    // Remove the edit row
    editRow.remove();

    // Check if table only has the "add-row-trigger" left (no actual entries)
    const dataRows = Array.from(tbody.querySelectorAll('tr')).filter(row => {
        return row.id !== 'add-row-trigger' && row.id !== 'empty-state-row' && !row.hasAttribute('data-edit-row');
    });

    // If no data rows exist, restore the empty state
    if (dataRows.length === 0) {
        const emptyStateRow = document.createElement('tr');
        emptyStateRow.id = 'empty-state-row';
        emptyStateRow.innerHTML = `
            <td colspan="10" class="text-center py-12">
                <div class="text-base-content/50 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-16 h-16 mx-auto"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
                </div>
                <p class="text-lg font-medium text-base-content/70">Keine Zeiteinträge gefunden</p>
                <p class="text-sm text-base-content/50 mt-2">Erstellen Sie einen neuen Eintrag, um zu beginnen.</p>
            </td>
        `;

        // Insert before the add-row-trigger
        const addRowTrigger = tbody.querySelector('#add-row-trigger');
        if (addRowTrigger) {
            tbody.insertBefore(emptyStateRow, addRowTrigger);
        }
    }
};

// Auto-focus start time field when new row is added
(function() {
    const newRow = document.getElementById('{{ row_id }}');
    if (newRow) {
        const startTimeInput = newRow.querySelector('input[name="start_time"]');
        if (startTimeInput) {
            // Use setTimeout to ensure DOM is fully settled
            setTimeout(() => {
                startTimeInput.focus();
                startTimeInput.select(); // Also select any pre-filled value
            }, 50);
        }
    }
})();
</script>
{% endif %}
